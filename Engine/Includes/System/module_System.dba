//////////////////////////////////////////////////////////////
//  Game Engine Standard Modules - CORE SYSTEM MODULE
//  Concept and code by thenerd, Winter 2013!
//////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////
//  DOCUMENTATION
//////////////////////////////////////////////////////////////
//
//////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////
// Constants
//////////////////////////////////////////////////////////////

#constant CONFIGFILE "Config\game.cfg"

//////////////////////////////////////////////////////////////
// Udts
//////////////////////////////////////////////////////////////

Type t_Screen
	Width As Integer
	Height As Integer
	MiddleWidth As Integer
	MiddleHeight as Integer
	Depth As Integer
	Vsync As Boolean
	Fullscreen As Boolean
	AA As Integer
	ShowFPS as boolean
endtype

//////////////////////////////////////////////////////////////
// Functions
//////////////////////////////////////////////////////////////

Function SYS_Init():
	//////////////////////////////////////
	// Load lua config and set window mode
	//////////////////////////////////////	
	
	if cl$()="" then exit prompt "OpenFPS.exe: Run without dependency. Use Launcher.exe!","Error":end
	
	If File Exist(CONFIGFILE)=0:
		open to write 1,"config\game.cfg"
		write string 1,"ScreenWidth=640"
		write string 1,"ScreenHeight=480"
		write string 1,"ScreenDepth=32"
		write string 1,"Vsync=0"
		Write String 1,"Fullscreen=0"
		close file 1
	Endif
	
	Global Screen As t_Screen
	Lua Make : Lua Load File CONFIGFILE
	
   Screen.Width = 		lua Int("ScreenWidth")
   Screen.Height = 		lua Int("ScreenHeight")
	Screen.Depth = 		lua Int("ScreenDepth")
   Screen.Vsync = 		lua Int("Vsync")
	Screen.Fullscreen =  lua Int("Fullscreen")
   Screen.AA = 			lua Int("AA")
	
	global NetworkName as string
   NetworkName = 			lua string$("NetworkName")
	Global NetworkPort As Integer
	NetworkPort = 			lua int("Port")
	
	Set Display Mode Screen.Width,Screen.Height,Screen.Depth,Screen.Vsync,Screen.AA,0
   if Screen.Fullscreen=1 then set window off
	If Screen.Fullscreen=0 Then Set Window On
	
	//center window
	window = Get Dbpro Window ()
	Position Window window,(desktop width()/2)-(GET WINDOW CLIENT width(window)/2),(desktop height()/2)-(GET WINDOW CLIENT HEIGHT(window)/2)

	
	//////////////////////////////////////
	// Do standard Dbpro setup
	//////////////////////////////////////
	
	Sync on : sync rate 0 : autocam off
	Disable Escapekey : Hide Mouse
	
	//////////////////////////////////////
	// Do plugin setup
	//////////////////////////////////////
	
	D3d_Init
	D3d_Font 1,"16",24,1,0,1
	
	global TERMINATE_FLAG as boolean
	
Endfunction

Function SYS_Sync():
	
	//////////////////////////////////////
	// Sync function. called once per loop.
	// Modify to add sync-limiter.
	//////////////////////////////////////
	
	if Screen.ShowFPS:
	D3d_Starttext
	d3d_text 1,Screen.Width-10,10,2,str$(screen fps())
	D3d_Endtext
	Endif
	
	Sync
	
Endfunction

Function Sys_ToggleFPS():
	Screen.ShowFPS = 1 - Screen.ShowFPS
	If Screen.ShowFPS = 1:
		Sync Rate 60
	else:
		Sync Rate 0
	endif
Endfunction

Function SYS_Terminate():
Endfunction

Function SYS_Reset():
Endfunction

//////////////////////////////////////////////////////////////
// End of code
//////////////////////////////////////////////////////////////