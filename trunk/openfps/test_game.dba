remstart
/////////////////////////////////////////////////////
//
//   OpenFPS
//   MAIN SOURCE
//
//
/////////////////////////////////////////////////////

----- Changelog (main source file only):
(11/19/09) - BMacZero - Created
(11/23/09) - BMacZero - Added menu
(11/24/09) - BMacZero - [Removed BlitzTerrain temporarily]
(2/7/10)   - thenerd  - Changed screen res to 1024x768x32 fullscreen, worked on menu functions
(2/15/10)  - BMacZero - Updated BlitzTerrain code for BT 2.0
(2/25/10)  - BMacZero - Globalized timerbased system, added shooting
(2/28/10)  - BMacZero - Removed BT temporary code
(2/28/10)  - Kaedroho - Position mouse to centre of the screen added. This stops the program from exiting when using multiple monitors.
(6/23/10)  - miso     - Replaced 2 standard text command to the new UI_Text command, yet using placeholder fonts
(6/23/10)  - miso     - Added an UI_CenterText command, just to show how it works, can be deleted
(6/26/10)  - miso     - Wrote a To-Do note.
(6/27/10)  - thenerd  - Added some effects to the menu background.
(6/27/10)  - thenerd  - Added some effects to the menu background.
(6/27/10)  - miso     - Repositioned the texts to give space for the appearing console
(6/27/10)  - miso     - Added variable SyS_Event_Terminate, to properly jump to the
                        terminate functions part. Set this to 1 of you want to terminate
                        instead of an "end" command. I put it here, because I dont know which
                        module would fit best to contain it. Reposition it if you have a better idea,
                        or I suggest to create a module_core or module_System, 
                        so I should put my debug commands there too.
                      - Added label _terminate:
(7/29/10)  		      - Added to game engine.

----- To-Do
Modules should be init between initMenu() and runMenu().

Important note for all modules: don't use mousemovex() and mousemovey() commands, it clears the mouse movement buffer.
                                Instead, use SyS_MouseMoveX and SyS_MouseMoveY integer variables if needed,
                                they get their value every loop. (miso.)

remend

`==========Globals==========`
Global SyS_Event_Terminate as Boolean : `set this variable to 1 to force the main module
                                      : `to run the terminate functions. 
                                      : `(I need it to close my logfile)

/////////////////////////////////////////////////////////
// INIT                                                //
/////////////////////////////////////////////////////////

sync on : sync rate 60
set display mode 1024,768,screen depth(),1
autocam off
randomize timer()
hide mouse
disable escapekey

`/ INITIATE CORE MODULES
initResource()

`/ INITIATE USER INTERFACE MODULE
UI_init():`best to init before initMenu(), it may use UI commands later.

`/ START LOADING
initMenu()

`/ RUN MENU
runMenu()

`clear gui
UI_ClearAllGuis()

`Init other modules here
initTerrain()
initVisuals()
`Temporary
LoadTerrainFromFile("media/BlitzTerrain/Terrain.blitz","media/BlitzTerrain/texture.jpg","media/BlitzTerrain/detail.tga")


`initMovement()
initShooting()
`initAI()

//Setup camera
set camera range 10,10000000000
hide mouse

/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////
// MAIN LOOP                                           //
/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////

`Timerbased
global elapsedtime as float
global timer_starttime as dword
timer_starttime = timer()

`player start
position camera 300,0,300


do

`grr bug
if object exist(menu_bgfx1)=1 then hide object menu_bgfx1


`Timerbased
elapsedtime=(timer()-timer_starttime)/1000.0
timer_starttime = timer()

updateTerrain()
	`updateMovement()

		Elapsedtime#=(timer()-StartTime)/3000.0+Elapsedtime#*0.7
		StartTime=timer()
		cx#=camera angle x()+mousemovey()/4.0
		if cx#>90.0 then cx#=90.0
		if cx#<-90.0 then cx#=-90.0
		rotate camera cx#,camera angle y()+mousemovex()/4.0,0.0
		if upkey() or KEYSTATE(17) then move camera 400.0*Elapsedtime#
		if downkey() or KEYSTATE(31) then move camera -400.0*Elapsedtime#
		if leftkey() or KEYSTATE(30) then move camera left 400.0*Elapsedtime#
		if rightkey() or KEYSTATE(32) then move camera left -400.0*Elapsedtime#
		gheight#=BT GetGroundHeight(g_Terrain_Main.dwTerrainID,camera position x(),camera position z())
		position camera camera position x(),gheight#+60,camera position z()

		
	updateShooting()
	`updateAI()
	
	//displays some info
	`UI_Text(1,10,55,str$(screen fps()))
	`UI_Text(1,10,70,"Stamina: "+str$(PLR_curstam))
	UI_putwindow(0,48+UI_EVENT_ConsoleOffset,17,9)
	UI_Text(2,10,80+UI_EVENT_ConsoleOffset,"Open FPS Engine")
	`UI_Centertext(3,UI_display.middlewidth,UI_display.height-40,"<Center Text Showcase, delete this line>")
	//handle all Gui functions
	if DebugScreen=1:
		UI_Text(2,screen width()-50,screen height()-40,str$(screen fps())) 
		UI_Centertext(3,UI_display.middlewidth,UI_display.height-40,"<Center Text Showcase, delete this line>")
		UI_Text(1,10,70+UI_EVENT_ConsoleOffset,"Stamina: "+str$(PLR_curstam))
		UI_Text(1,10,55+UI_EVENT_ConsoleOffset,str$(screen fps()))
	endif


position mouse screen width()/2,screen height()/2

//test command for mouse fade, can be deleted.


//Updates sky
`if KEYSTATE(18)=1 then vis_game_end()
updateVisuals()

//Updates user interface
UI_Handle()

//Syncronize backbuffers
sync
//checks if any module triggered a quit event
If SyS_Event_Terminate=1 then goto _terminate



//-----------------main loop end
loop

//---label _terminate:
	_terminate:
		terminateMovement()
		terminateShooting()
		terminateAI()
		terminateResource()
		terminateTerrain()
	_terminate_via_menu:
		terminateUI()
		UI_Stopdebugmode()
		UI_WriteLog(UI_Red,"Program Ended.")
end
